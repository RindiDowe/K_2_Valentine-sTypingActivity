<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Valentine Typing ‚Ä¢ K‚Äì2</title>
  <style>
    :root{
      --red:#c81e1e; --red2:#e11d48; --pink:#ff4d8d; --soft:#fff1f2;
      --card:#ffffffcc; --shadow: 0 10px 30px rgba(0,0,0,.12);
      --ink:#1f2937;

      --key:#f8fafc; --keyInk:#111827; --keyBorder:#e5e7eb;
      --keyNeed:#fecdd3; --keyDown:#bbf7d0; --keyPulse:#ffe4e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 15% 10%, #ffd6e3 0%, transparent 55%),
        radial-gradient(900px 500px at 85% 15%, #ffe4e6 0%, transparent 55%),
        linear-gradient(160deg, #fff 0%, #fff5f7 45%, #fff 100%);
    }
    .app{height:100vh; display:flex; flex-direction:column; padding:12px; gap:10px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:16px;
      background:linear-gradient(90deg, var(--red) 0%, var(--red2) 50%, var(--pink) 100%);
      color:#fff; box-shadow:var(--shadow); min-height:64px;
    }
    .titleWrap{display:flex; flex-direction:column; gap:2px; line-height:1.1;}
    .title{font-weight:900; letter-spacing:.3px; font-size:clamp(16px,2.2vw,22px);}
    .subtitle{font-size:clamp(12px,1.5vw,14px); opacity:.95;}
    .controls{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:none; border-radius:12px; padding:9px 10px; font-weight:900;
      cursor:pointer; background:#fff; color:#7f1d1d; font-size:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.12); user-select:none; white-space:nowrap;
      transition:transform .06s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px);}
    .btn.secondary{background:rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.35); box-shadow:none;}
    .btn.active{outline:3px solid rgba(255,255,255,.55); filter:brightness(1.03);}
    .btn.next{
      background:linear-gradient(90deg,#fff 0%,#ffe4e6 60%,#fff 100%);
      color:#9f1239; border:1px solid #fecdd3; box-shadow:0 10px 18px rgba(225,29,72,.18);
    }

    .main{flex:1; display:flex; flex-direction:column; gap:10px; min-height:0;}
    .topRow{display:grid; grid-template-columns:1.2fr .8fr; gap:10px; min-height:0;}
    .panel{
      background:var(--card); border:1px solid rgba(255,255,255,.7);
      border-radius:18px; box-shadow:var(--shadow); padding:12px;
      display:flex; flex-direction:column; gap:10px; overflow:hidden; min-height:0;
      backdrop-filter:blur(6px);
    }
    .statusRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .pill{
      display:inline-flex; align-items:center; gap:8px; border-radius:999px;
      padding:8px 10px; background:#fff; border:1px solid #ffe4e6;
      font-weight:900; font-size:14px; color:#7f1d1d; user-select:none;
    }
    .progressWrap{width:100%; background:#fff; border:1px solid #ffe4e6; border-radius:999px; overflow:hidden; height:14px;}
    .progressBar{height:100%; width:0%; background:linear-gradient(90deg,var(--pink) 0%, var(--red2) 55%, var(--red) 100%); transition:width .18s ease;}

    .promptBox{
      position:relative;
      display:flex; align-items:center; justify-content:center;
      border-radius:16px;
      background:linear-gradient(180deg,#fff 0%, var(--soft) 100%);
      border:1px solid #ffe4e6;
      padding:12px; flex:1; min-height:0;
    }
    canvas#confetti{position:absolute; inset:0; pointer-events:none; z-index:2; border-radius:16px;}
    .promptText{
      z-index:1;
      text-align:center; font-weight:900; letter-spacing:.5px; user-select:none;
      font-size:clamp(30px,6vw,64px);
      color:#9f1239; text-shadow:0 3px 0 rgba(255,182,193,.35);
      padding:6px 10px;
    }
    .promptText.wordBig{
      font-size: clamp(34px, 6.5vw, 74px);
      letter-spacing: .8px;
      text-transform: lowercase;
    }

    .hint{
      background:#fff; border:1px solid #ffe4e6; border-radius:16px; padding:10px;
      line-height:1.25; font-size:14px;
    }
    .hint strong{color:#9f1239}
    .small{font-size:13px; opacity:.92;}

    .wordAreaLeft{
      display:none;
      background:#fff;
      border:1px solid #ffe4e6;
      border-radius:16px;
      padding:10px;
    }

    /* Dotted-underlined target letters; typed letters turn green/red */
    .typedLine{
      margin-top:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#0b1020; color:#fff; border-radius:14px; padding:10px;
      font-size:clamp(16px,2.2vw,20px);
      min-height:48px; display:flex; align-items:center;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
      gap:2px;
    }
    .ch{ display:inline-block; min-width:0.65em; text-align:center; padding:0 1px; }
    .ch.pending{
      color: rgba(255,255,255,.55);
      border-bottom: 2px dotted rgba(255,255,255,.35);
      transform: translateY(-1px);
    }
    .ch.ok{ color:#86efac; }
    .ch.bad{ color:#fca5a5; }

    /* =======================
       KEYBOARD (full Chromebook)
       Fix: make sure it fits / scrolls so you can SEE the new rows
       ======================= */
    .keyboardPanel{
      background:rgba(255,255,255,.92);
      border:1px solid #ffe4e6;
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:10px;
      flex: 0 0 auto;
    }
    .kbTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; flex-wrap:wrap;}
    .toggle{display:inline-flex; align-items:center; gap:8px; font-weight:900; font-size:14px; user-select:none;}
    .toggle input{transform:scale(1.2);}

    .kb{
      display:flex;
      flex-direction:column;
      gap:6px;
      user-select:none;

      /* IMPORTANT: show all rows on short screens */
      max-height: 320px;
      overflow:auto;
      padding-bottom:6px;
    }
    .row{
      display:grid;
      gap:6px;
      align-items:center;
    }
    .row.r1{ grid-template-columns: repeat(12, 1fr); }
    .row.r2{ grid-template-columns: repeat(13, 1fr) 1.6fr; }
    .row.r3{ grid-template-columns: 1.4fr repeat(12, 1fr) 1.5fr; }
    .row.r4{ grid-template-columns: 1.6fr repeat(11, 1fr) 1.6fr; }
    .row.r5{ grid-template-columns: 2.1fr repeat(10, 1fr) 2.1fr; }
    .row.r6{ grid-template-columns: 1.2fr 1.2fr 5fr 1.2fr 1.2fr 1.1fr 1.1fr 1.1fr; }

    .key{
      background:var(--key);
      border:1px solid var(--keyBorder);
      border-bottom:3px solid #d1d5db;
      color:var(--keyInk);
      border-radius:9px;
      height:34px;
      padding:0 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      min-width:0;
    }
    .key.small{ font-size:11px; font-weight:800; opacity:.95; }
    .key.icon{ font-size:13px; }
    .key.need{background:var(--keyNeed); border-color:#fb7185;}
    .key.down{background:var(--keyDown); border-color:#22c55e; transform:translateY(1px);}
    .key.pulse{background:var(--keyPulse); border-color:#fb7185;}

    @media (max-width:980px){
      .topRow{grid-template-columns:1fr;}
      .key{height:32px; font-size:11px;}
      .key.icon{font-size:12px;}
      .kb{max-height:300px;}
      header{min-height:62px;}
    }
    @media (max-width:480px){
      .key{height:30px; font-size:10px;}
      .key.icon{font-size:11px;}
      .kb{max-height:260px;}
    }
    @media (max-height: 720px){
      .kb{ max-height: 260px; }
      .key{ height:32px; }
    }

    .overlay{
      position:fixed; inset:0; background:rgba(255,255,255,.72); backdrop-filter:blur(6px);
      display:none; align-items:center; justify-content:center; z-index:50; padding:16px;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(680px,96vw);
      background:#fff; border:2px solid #ffe4e6; border-radius:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.22);
      padding:16px; text-align:center;
    }
    .modal h2{margin:6px 0 8px; color:#9f1239; font-size:clamp(20px,3vw,28px); font-weight:900;}
    .modal p{margin:0 0 14px; color:#7f1d1d; font-weight:900; font-size:15px;}
    .modalActions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="titleWrap">
        <div class="title">‚ù§Ô∏è Valentine Typing ‚Ä¢ K‚Äì2</div>
        <div class="subtitle">Type the prompt ‚Ä¢ Keyboard helper highlights the next key</div>
      </div>
      <div class="controls">
        <button class="btn active" id="lvl1">Level 1: abc‚Ä¶</button>
        <button class="btn" id="lvl2">Level 2: ABC‚Ä¶</button>
        <button class="btn" id="lvl3">Level 3: Words</button>
        <button class="btn secondary" id="restart">Restart</button>
      </div>
    </header>

    <div class="main">
      <div class="topRow">
        <section class="panel">
          <div class="statusRow">
            <div class="pill" id="levelLabel">Level 1</div>
            <div class="pill" id="stepLabel">1 / 13</div>
          </div>

          <div class="progressWrap" aria-label="progress">
            <div class="progressBar" id="progressBar"></div>
          </div>

          <div class="promptBox">
            <canvas id="confetti"></canvas>
            <div class="promptText" id="prompt">a</div>
          </div>

          <div class="wordAreaLeft" id="wordAreaLeft">
            <div class="small"><strong>Type the word:</strong> (Backspace works)</div>
            <div class="typedLine" id="typedLine"></div>
          </div>

          <div class="hint small">Tip: Look at the keyboard ‚Äî the <strong>next key</strong> is highlighted.</div>
        </section>

        <aside class="panel">
          <div class="hint">
            <div><strong>Goal:</strong> <span id="goalText">Type the lowercase letters a‚Äìm.</span></div>
            <div class="small">Backspace works in word level.</div>
          </div>
          <div class="hint">
            <div><strong>Hearts earned:</strong> <span id="hearts">0</span> üíó</div>
            <div class="small">You get a heart for every correct key!</div>
          </div>
          <div class="hint small"><strong>Teacher note:</strong> Students only type ‚Äî no clicking needed.</div>
        </aside>
      </div>

      <section class="keyboardPanel">
        <div class="kbTop">
          <div class="pill">Chromebook keyboard helper</div>
          <label class="toggle">
            <input type="checkbox" id="assist" checked />
            Highlight next key
          </label>
        </div>
        <div class="kb" id="kb"></div>
      </section>
    </div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="overlayTitle">Level Complete! üíñ</h2>
      <p id="overlayText">Ready for the next level?</p>
      <div class="modalActions">
        <button class="btn next" id="nextLevelBtn">Next Level ‚ûú</button>
        <button class="btn next" id="playAgainBtn" style="display:none;">Play Again ‚Ü∫</button>
        <button class="btn secondary" id="stayBtn">Practice Again</button>
      </div>
    </div>
  </div>

  <script>
    const levelData = {
      1:{name:"Level 1", goal:"Type the lowercase letters a‚Äìm.", items:"abcdefghijklm".split(""), mode:"chars"},
      2:{name:"Level 2", goal:"Type the uppercase letters N‚ÄìZ.", items:"NOPQRSTUVWXYZ".split(""), mode:"chars"},
      3:{name:"Level 3", goal:"Type Valentine words.", items:["red","pink","flowers","card","candy","love","share","heart","note","nice","poem"], mode:"words"}
    };

    let level=1, index=0, hearts=0, wordTyped="", expectedKey="", finished=false;

    const promptEl=document.getElementById("prompt");
    const levelLabelEl=document.getElementById("levelLabel");
    const stepLabelEl=document.getElementById("stepLabel");
    const progressEl=document.getElementById("progressBar");
    const goalTextEl=document.getElementById("goalText");
    const heartsEl=document.getElementById("hearts");
    const assistEl=document.getElementById("assist");
    const kbEl=document.getElementById("kb");
    const wordAreaLeftEl=document.getElementById("wordAreaLeft");
    const typedLineEl=document.getElementById("typedLine");

    const btn1=document.getElementById("lvl1");
    const btn2=document.getElementById("lvl2");
    const btn3=document.getElementById("lvl3");
    const restartBtn=document.getElementById("restart");

    const overlayEl=document.getElementById("overlay");
    const overlayTitleEl=document.getElementById("overlayTitle");
    const overlayTextEl=document.getElementById("overlayText");
    const nextLevelBtn=document.getElementById("nextLevelBtn");
    const playAgainBtn=document.getElementById("playAgainBtn");
    const stayBtn=document.getElementById("stayBtn");

    // Confetti
    const confettiCanvas = document.getElementById("confetti");
    const ctx = confettiCanvas.getContext("2d");
    let confettiPieces=[], confettiTimer=0;

    // Full Chromebook visual layout
    const KB = {
      r1: [
        {key:"esc", t:"esc", cls:"small"},
        {key:"browser-back", t:"‚Üê", cls:"icon"},
        {key:"browser-forward", t:"‚Üí", cls:"icon"},
        {key:"reload", t:"‚ü≥", cls:"icon"},
        {key:"fullscreen", t:"‚õ∂", cls:"icon"},
        {key:"overview", t:"‚ñ≠‚ñ≠", cls:"small"},
        {key:"brightness-down", t:"‚òÄÔ∏é", cls:"icon"},
        {key:"brightness-up", t:"‚òÄ", cls:"icon"},
        {key:"mute", t:"üîá", cls:"icon"},
        {key:"volume-down", t:"üîâ", cls:"icon"},
        {key:"volume-up", t:"üîä", cls:"icon"},
        {key:"power", t:"‚èª", cls:"icon"},
      ],
      r2: [
        {key:"`", t:"~"},
        {key:"1", t:"1"},
        {key:"2", t:"2"},
        {key:"3", t:"3"},
        {key:"4", t:"4"},
        {key:"5", t:"5"},
        {key:"6", t:"6"},
        {key:"7", t:"7"},
        {key:"8", t:"8"},
        {key:"9", t:"9"},
        {key:"0", t:"0"},
        {key:"-", t:"-"},
        {key:"=", t:"="},
        {key:"backspace", t:"backspace", cls:"small"}
      ],
      r3: [
        {key:"tab", t:"tab", cls:"small"},
        ...("qwertyuiop".split("").map(ch=>({key:ch, t:ch}))),
        {key:"[", t:"["},
        {key:"]", t:"]"},
        {key:"\\", t:"\\"},
        {key:"enter", t:"enter", cls:"small"}
      ],
      r4: [
        {key:"search", t:"‚åï", cls:"icon"},
        ...("asdfghjkl".split("").map(ch=>({key:ch, t:ch}))),
        {key:";", t:";"},
        {key:"'", t:"'"},
        {key:"enter", t:"enter", cls:"small"}
      ],
      r5: [
        {key:"shift", t:"shift", cls:"small"},
        ...("zxcvbnm".split("").map(ch=>({key:ch, t:ch}))),
        {key:",", t:","},
        {key:".", t:"."},
        {key:"/", t:"/"},
        {key:"shift-right", t:"shift", cls:"small"}
      ],
      r6: [
        {key:"ctrl", t:"ctrl", cls:"small"},
        {key:"alt-left", t:"alt", cls:"small"},
        {key:"space", t:"space", cls:"small"},
        {key:"alt-right", t:"alt", cls:"small"},
        {key:"ctrl-right", t:"ctrl", cls:"small"},
        {key:"arrowleft", t:"‚óÄ", cls:"icon"},
        {key:"arrowdown", t:"‚ñº", cls:"icon"},
        {key:"arrowright", t:"‚ñ∂", cls:"icon"}
      ]
    };

    function makeKeyEl(obj){
      const el = document.createElement("div");
      el.className = "key" + (obj.cls ? (" " + obj.cls) : "");
      el.dataset.key = obj.key;
      el.textContent = obj.t;
      return el;
    }
    function buildKeyboard(){
      kbEl.innerHTML = "";
      const r1 = document.createElement("div"); r1.className="row r1"; KB.r1.forEach(o=>r1.appendChild(makeKeyEl(o))); kbEl.appendChild(r1);
      const r2 = document.createElement("div"); r2.className="row r2"; KB.r2.forEach(o=>r2.appendChild(makeKeyEl(o))); kbEl.appendChild(r2);
      const r3 = document.createElement("div"); r3.className="row r3"; KB.r3.forEach(o=>r3.appendChild(makeKeyEl(o))); kbEl.appendChild(r3);
      const r4 = document.createElement("div"); r4.className="row r4"; KB.r4.forEach(o=>r4.appendChild(makeKeyEl(o))); kbEl.appendChild(r4);
      const r5 = document.createElement("div"); r5.className="row r5"; KB.r5.forEach(o=>r5.appendChild(makeKeyEl(o))); kbEl.appendChild(r5);
      const r6 = document.createElement("div"); r6.className="row r6"; KB.r6.forEach(o=>r6.appendChild(makeKeyEl(o))); kbEl.appendChild(r6);
    }

    function clearKeyClasses(){
      document.querySelectorAll(".key").forEach(el=>el.classList.remove("need","down","pulse"));
    }
    function normalizeExpectedKey(k){
      if(!k) return "";
      const low = k.toLowerCase();
      if (low === "backspace") return "backspace";
      if (low === "enter") return "enter";
      if (low === "shift") return "shift";
      return low; // letters
    }
    function highlightExpected(){
      clearKeyClasses();
      if(!assistEl.checked || !expectedKey) return;
      const nk = normalizeExpectedKey(expectedKey);
      const el = document.querySelector(`.key[data-key="${nk}"]`);
      if(el) el.classList.add("need");
    }
    function showKeyDown(datasetKey){
      const el = document.querySelector(`.key[data-key="${datasetKey}"]`);
      if(!el) return;
      el.classList.add("down");
      setTimeout(()=>el.classList.remove("down"),120);
    }
    function pulseExpected(){
      if(!assistEl.checked || !expectedKey) return;
      const nk = normalizeExpectedKey(expectedKey);
      const el = document.querySelector(`.key[data-key="${nk}"]`);
      if(!el) return;
      el.classList.add("pulse");
      setTimeout(()=>el.classList.remove("pulse"),220);
    }

    function setActiveButton(){
      [btn1,btn2,btn3].forEach(b=>b.classList.remove("active"));
      if(level===1) btn1.classList.add("active");
      if(level===2) btn2.classList.add("active");
      if(level===3) btn3.classList.add("active");
    }
    function totalSteps(){ return levelData[level].items.length; }
    function updateProgress(){
      const total=totalSteps();
      const done=Math.min(index,total);
      progressEl.style.width=`${(done/total)*100}%`;
      stepLabelEl.textContent=`${Math.min(index+1,total)} / ${total}`;
      heartsEl.textContent=`${hearts}`;
    }

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function renderTypedLine(target, typed){
      let html="";
      for(let i=0;i<target.length;i++){
        const t=target[i];
        const u=typed[i];
        if(u==null) html += `<span class="ch pending">${escapeHtml(t)}</span>`;
        else if(u===t) html += `<span class="ch ok">${escapeHtml(u)}</span>`;
        else html += `<span class="ch bad">${escapeHtml(u)}</span>`;
      }
      typedLineEl.innerHTML = html || "<span class='small'>Start typing‚Ä¶</span>";
    }

    function setPromptForChars(){
      const current=levelData[level].items[index];
      finished=false;

      wordAreaLeftEl.style.display="none";
      promptEl.classList.remove("wordBig");
      promptEl.textContent=current || "";

      if(current && /^[A-Z]$/.test(current)) expectedKey="shift";
      else expectedKey=(current||"").toLowerCase();

      highlightExpected();
    }
    function setPromptForWords(){
      const target=levelData[level].items[index];
      finished=false;

      promptEl.classList.add("wordBig");
      promptEl.textContent=target;

      wordAreaLeftEl.style.display="block";
      renderTypedLine(target, wordTyped);

      expectedKey = target && target[wordTyped.length] ? target[wordTyped.length].toLowerCase() : "";
      highlightExpected();
    }

    function showOverlay(){
      const isLast = (level >= 3);
      overlayTitleEl.textContent = isLast ? "All Done! üíñüå∏" : `Level ${level} Complete! üíñ`;
      overlayTextEl.textContent  = isLast ? "Do you want to play again?" : "Great job! Ready for the next level?";
      nextLevelBtn.style.display = isLast ? "none" : "inline-flex";
      playAgainBtn.style.display = isLast ? "inline-flex" : "none";
      overlayEl.classList.add("show");
    }
    function hideOverlay(){ overlayEl.classList.remove("show"); }

    function resizeConfetti(){
      const box=confettiCanvas.parentElement.getBoundingClientRect();
      confettiCanvas.width=Math.floor(box.width * devicePixelRatio);
      confettiCanvas.height=Math.floor(box.height * devicePixelRatio);
      confettiCanvas.style.width=box.width+"px";
      confettiCanvas.style.height=box.height+"px";
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    function drawHeart(x,y,r,rot,color){
      ctx.save(); ctx.translate(x,y); ctx.rotate(rot); ctx.fillStyle=color;
      const s=r/10;
      ctx.beginPath();
      ctx.moveTo(0,3*s);
      ctx.bezierCurveTo(0,-2*s,-5*s,-2*s,-5*s,2*s);
      ctx.bezierCurveTo(-5*s,6*s,0,8*s,0,10*s);
      ctx.bezierCurveTo(0,8*s,5*s,6*s,5*s,2*s);
      ctx.bezierCurveTo(5*s,-2*s,0,-2*s,0,3*s);
      ctx.closePath(); ctx.fill(); ctx.restore();
    }
    function drawFlower(x,y,r,rot,color){
      ctx.save(); ctx.translate(x,y); ctx.rotate(rot);
      const petals=6;
      ctx.fillStyle=color;
      for(let i=0;i<petals;i++){
        ctx.rotate((Math.PI*2)/petals);
        ctx.beginPath();
        ctx.ellipse(0,-r*0.6,r*0.35,r*0.55,0,0,Math.PI*2);
        ctx.fill();
      }
      ctx.fillStyle="#ffd1dc";
      ctx.beginPath(); ctx.arc(0,0,r*0.25,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
    function spawnConfettiBurst(){
      resizeConfetti();
      const box=confettiCanvas.getBoundingClientRect();
      const cx=box.width/2, cy=box.height/2;
      const shapes=["heart","flower"];
      const colors=["#e11d48","#c81e1e","#ff4d8d","#ffb3c7","#ffffff"];
      for(let i=0;i<90;i++){
        const ang=Math.random()*Math.PI*2;
        const sp=2.2+Math.random()*3.2;
        confettiPieces.push({
          x:cx+(Math.random()*30-15), y:cy+(Math.random()*10-5),
          vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp-(1.5+Math.random()*1.2),
          r:6+Math.random()*8, rot:Math.random()*Math.PI*2, vr:(Math.random()-.5)*0.25,
          g:0.09+Math.random()*0.05, life:90+Math.random()*40,
          shape:shapes[(Math.random()*shapes.length)|0],
          color:colors[(Math.random()*colors.length)|0]
        });
      }
      confettiTimer=140;
      requestAnimationFrame(drawConfetti);
    }
    function drawConfetti(){
      if(confettiTimer<=0){
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        confettiPieces=[];
        return;
      }
      const box=confettiCanvas.getBoundingClientRect();
      ctx.clearRect(0,0,box.width,box.height);
      confettiPieces=confettiPieces.filter(p=>p.life>0);
      for(const p of confettiPieces){
        p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.rot+=p.vr; p.life-=1;
        if(p.shape==="heart") drawHeart(p.x,p.y,p.r,p.rot,p.color);
        else drawFlower(p.x,p.y,p.r,p.rot,p.color);
      }
      confettiTimer-=1;
      requestAnimationFrame(drawConfetti);
    }
    window.addEventListener("resize", resizeConfetti);

    function finishLevel(){
      finished=true;
      progressEl.style.width="100%";
      stepLabelEl.textContent=`${totalSteps()} / ${totalSteps()}`;
      promptEl.classList.remove("wordBig");
      promptEl.textContent="üíóüå∏";
      expectedKey="";
      highlightExpected();
      spawnConfettiBurst();
      setTimeout(showOverlay,450);
    }

    function loadLevel(newLevel){
      level=newLevel; index=0; wordTyped=""; finished=false;
      setActiveButton();
      levelLabelEl.textContent=levelData[level].name;
      goalTextEl.textContent=levelData[level].goal;
      hideOverlay();
      if(levelData[level].mode==="chars") setPromptForChars();
      else setPromptForWords();
      updateProgress();
    }
    function restart(){
      index=0; wordTyped=""; hearts=0; finished=false;
      hideOverlay();
      if(levelData[level].mode==="chars") setPromptForChars();
      else setPromptForWords();
      updateProgress();
    }
    function restartAll(){ hearts=0; loadLevel(1); }

    function showKeyDownFromEvent(e){
      if(e.key==="Backspace") showKeyDown("backspace");
      else if(e.key==="Enter") showKeyDown("enter");
      else if(e.key==="Shift") showKeyDown("shift");
      else if(/^[a-z]$/i.test(e.key)) showKeyDown(e.key.toLowerCase());
      else if(e.key===" ") showKeyDown("space");
      else if(e.key==="Tab") showKeyDown("tab");
      else if(e.key==="ArrowLeft") showKeyDown("arrowleft");
      else if(e.key==="ArrowDown") showKeyDown("arrowdown");
      else if(e.key==="ArrowRight") showKeyDown("arrowright");
      else if(e.key==="Escape") showKeyDown("esc");
    }

    function handleCharModeKey(e){
      const want=levelData[level].items[index];
      if(!want) return;
      showKeyDownFromEvent(e);
      if(e.key===want){
        hearts++; index++; updateProgress();
        if(index>=levelData[level].items.length){ finishLevel(); return; }
        setPromptForChars();
      }else pulseExpected();
    }
    function handleWordModeKey(e){
      const target=levelData[level].items[index];
      if(!target) return;
      showKeyDownFromEvent(e);

      if(e.key==="Backspace"){
        wordTyped=wordTyped.slice(0,-1);
        renderTypedLine(target, wordTyped);
        expectedKey = target[wordTyped.length] ? target[wordTyped.length].toLowerCase() : "";
        highlightExpected();
        return;
      }
      if(!/^[a-z]$/i.test(e.key)) return;

      const ch=e.key.toLowerCase();
      const nextWanted=target[wordTyped.length];
      wordTyped += ch;

      if(ch===nextWanted) hearts++;
      else pulseExpected();

      renderTypedLine(target, wordTyped);

      if(wordTyped.length>=target.length){
        if(wordTyped===target){
          index++; wordTyped=""; updateProgress();
          if(index>=levelData[level].items.length){ finishLevel(); return; }
          setPromptForWords();
        }else{
          wordTyped=""; renderTypedLine(target, wordTyped);
          expectedKey = target[0] ? target[0].toLowerCase() : "";
          highlightExpected();
        }
      }else{
        expectedKey = target[wordTyped.length] ? target[wordTyped.length].toLowerCase() : "";
        highlightExpected();
      }
    }

    window.addEventListener("keydown",(e)=>{
      if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
      if(["Alt","Meta","Control"].includes(e.key)) return;
      if(finished) return;
      if(index>=totalSteps()) return;
      if(levelData[level].mode==="chars") handleCharModeKey(e);
      else handleWordModeKey(e);
    },{passive:false});

    btn1.addEventListener("click",()=>loadLevel(1));
    btn2.addEventListener("click",()=>loadLevel(2));
    btn3.addEventListener("click",()=>loadLevel(3));
    restartBtn.addEventListener("click",restart);
    assistEl.addEventListener("change",highlightExpected);

    nextLevelBtn.addEventListener("click",()=>loadLevel(Math.min(3, level+1)));
    stayBtn.addEventListener("click",()=>{
      hideOverlay();
      index=0; wordTyped=""; finished=false;
      if(levelData[level].mode==="chars") setPromptForChars();
      else setPromptForWords();
      updateProgress();
    });
    playAgainBtn.addEventListener("click",()=>{ hideOverlay(); restartAll(); });

    buildKeyboard();
    loadLevel(1);
    setTimeout(resizeConfetti,50);
  </script>
</body>
</html>
