<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Valentine Typing ‚Ä¢ K‚Äì2</title>
  <style>
    :root{
      --red:#c81e1e;
      --red2:#e11d48;
      --pink:#ff4d8d;
      --pink2:#ffb3c7;
      --white:#ffffff;
      --ink:#1f2937;
      --soft:#fff1f2;
      --card:#ffffffcc;
      --shadow: 0 10px 30px rgba(0,0,0,.12);

      --key:#f8fafc;
      --keyInk:#111827;
      --keyBorder:#e5e7eb;
      --keyNeed:#fecdd3; /* needed key */
      --keyDown:#bbf7d0; /* pressed */
      --keyPulse:#ffe4e6;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      height:100vh;
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 15% 10%, #ffd6e3 0%, transparent 55%),
        radial-gradient(900px 500px at 85% 15%, #ffe4e6 0%, transparent 55%),
        linear-gradient(160deg, #fff 0%, #fff5f7 45%, #fff 100%);
    }

    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:12px;
      gap:10px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background:linear-gradient(90deg, var(--red) 0%, var(--red2) 50%, var(--pink) 100%);
      color:white;
      box-shadow: var(--shadow);
      min-height:64px;
    }

    .titleWrap{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      gap:2px;
    }
    .title{
      font-weight:800;
      letter-spacing:.3px;
      font-size: clamp(16px, 2.2vw, 22px);
    }
    .subtitle{
      font-size: clamp(12px, 1.5vw, 14px);
      opacity:.95;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      border-radius:12px;
      padding:9px 10px;
      font-weight:800;
      cursor:pointer;
      background:#ffffff;
      color:#7f1d1d;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      transition: transform .06s ease, filter .2s ease;
      user-select:none;
      white-space:nowrap;
      font-size:14px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.18);
      color:white;
      border:1px solid rgba(255,255,255,.35);
      box-shadow:none;
    }
    .btn.active{
      outline:3px solid rgba(255,255,255,.55);
      filter: brightness(1.03);
    }
    .btn.next{
      background: linear-gradient(90deg, #fff 0%, #ffe4e6 60%, #fff 100%);
      color:#9f1239;
      border:1px solid #fecdd3;
      box-shadow: 0 10px 18px rgba(225,29,72,.18);
    }

    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .topRow{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:10px;
      min-height:0;
    }

    .panel{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.7);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
      backdrop-filter: blur(6px);
    }

    .promptBox{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:16px;
      background: linear-gradient(180deg, #fff 0%, var(--soft) 100%);
      border:1px solid #ffe4e6;
      padding:12px;
      flex:1;
      min-height:0;
    }

    .promptText{
      text-align:center;
      font-weight:900;
      font-size: clamp(30px, 6vw, 64px);
      color:#9f1239;
      text-shadow: 0 3px 0 rgba(255, 182, 193, .35);
      letter-spacing: .5px;
      user-select:none;
      padding:6px 10px;
      z-index:1;
    }

    .statusRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:8px 10px;
      background:#fff;
      border:1px solid #ffe4e6;
      font-weight:900;
      font-size:14px;
      color:#7f1d1d;
      user-select:none;
    }

    .progressWrap{
      width:100%;
      background:#fff;
      border:1px solid #ffe4e6;
      border-radius:999px;
      overflow:hidden;
      height:14px;
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--pink) 0%, var(--red2) 55%, var(--red) 100%);
      transition: width .18s ease;
    }

    .hint{
      background:#fff;
      border:1px solid #ffe4e6;
      border-radius:16px;
      padding:10px;
      line-height:1.25;
      font-size:14px;
    }
    .hint strong{color:#9f1239}
    .small{ font-size:13px; opacity:.92; }

    .sideInfo{ display:flex; flex-direction:column; gap:10px; min-height:0; }

    .wordLine{
      font-weight:900;
      font-size: clamp(18px, 2.3vw, 24px);
      color:#9f1239;
    }

    .typedLine{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#0b1020;
      color:#fff;
      border-radius:14px;
      padding:10px;
      font-size: clamp(14px, 2vw, 18px);
      min-height:44px;
      display:flex;
      align-items:center;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .typedLine .ok{ color:#bbf7d0; }
    .typedLine .bad{ color:#fecaca; }

    .keyboardPanel{
      background: rgba(255,255,255,.92);
      border:1px solid #ffe4e6;
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px;
      min-height:0;
    }

    .kbTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:14px;
      user-select:none;
    }
    .toggle input{ transform: scale(1.2); }

    .kb{ display:flex; flex-direction:column; gap:6px; user-select:none; }
    .row{ display:flex; gap:6px; justify-content:center; }

    .key{
      background: var(--key);
      border:1px solid var(--keyBorder);
      border-bottom:3px solid #d1d5db;
      color:var(--keyInk);
      border-radius:10px;
      height:42px;
      min-width:42px;
      padding:0 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .key.wide{ min-width:86px; }
    .key.enter{ min-width:92px; }
    .key.smallText{ font-size:13px; }
    .key.need{ background: var(--keyNeed); border-color:#fb7185; }
    .key.down{ background: var(--keyDown); border-color:#22c55e; transform: translateY(1px); }
    .key.pulse{ background: var(--keyPulse); border-color:#fb7185; }

    /* No-scroll Chromebook sizing */
    @media (max-width: 980px){
      .topRow{ grid-template-columns: 1fr; }
      .key{ height:38px; min-width:38px; border-radius:9px; }
      .key.wide{ min-width:76px; }
      .key.enter{ min-width:82px; }
      header{ min-height:62px; }
    }
    @media (max-width: 480px){
      .key{ height:34px; min-width:34px; font-size:14px; }
      .key.wide{ min-width:70px; }
      .key.enter{ min-width:76px; }
    }

    /* Inter-level overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:16px;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(680px, 96vw);
      background: #fff;
      border:2px solid #ffe4e6;
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      padding:16px;
      text-align:center;
    }
    .modal h2{
      margin:6px 0 8px;
      color:#9f1239;
      font-size: clamp(20px, 3vw, 28px);
      letter-spacing:.2px;
    }
    .modal p{
      margin:0 0 14px;
      color:#7f1d1d;
      font-weight:800;
      font-size: 15px;
    }
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    /* Confetti canvas */
    canvas#confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:2;
      border-radius:16px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="titleWrap">
        <div class="title">‚ù§Ô∏è Valentine Typing ‚Ä¢ K‚Äì2</div>
        <div class="subtitle">Type the prompt ‚Ä¢ Keyboard helper highlights the next key</div>
      </div>
      <div class="controls">
        <button class="btn active" id="lvl1">Level 1: abc‚Ä¶</button>
        <button class="btn" id="lvl2">Level 2: ABC‚Ä¶</button>
        <button class="btn" id="lvl3">Level 3: Words</button>
        <button class="btn secondary" id="restart">Restart</button>
      </div>
    </header>

    <div class="main">
      <div class="topRow">
        <section class="panel">
          <div class="statusRow">
            <div class="pill" id="levelLabel">Level 1</div>
            <div class="pill" id="stepLabel">1 / 13</div>
          </div>

          <div class="progressWrap" aria-label="progress">
            <div class="progressBar" id="progressBar"></div>
          </div>

          <div class="promptBox">
            <canvas id="confetti"></canvas>
            <div class="promptText" id="prompt">a</div>
          </div>

          <div class="hint small">
            Tip: Look at the keyboard ‚Äî the <strong>next key</strong> is highlighted.
          </div>
        </section>

        <aside class="panel sideInfo">
          <div class="hint">
            <div><strong>Goal:</strong> <span id="goalText">Type the lowercase letters a‚Äìm.</span></div>
            <div class="small">Backspace works in word level.</div>
          </div>

          <div class="hint" id="wordArea" style="display:none;">
            <div class="wordLine">Word:</div>
            <div class="wordLine" id="wordTarget">red</div>
            <div class="small" style="margin-top:6px;">Type the word.</div>
            <div class="typedLine" id="typedLine"></div>
          </div>

          <div class="hint">
            <div><strong>Hearts earned:</strong> <span id="hearts">0</span> üíó</div>
            <div class="small">You get a heart for every correct key!</div>
          </div>

          <div class="hint small">
            <strong>Teacher note:</strong> Students only type ‚Äî no clicking needed.
          </div>
        </aside>
      </div>

      <section class="keyboardPanel">
        <div class="kbTop">
          <div class="pill">Chromebook keyboard helper</div>
          <label class="toggle">
            <input type="checkbox" id="assist" checked />
            Highlight next key
          </label>
        </div>
        <div class="kb" id="kb"></div>
      </section>
    </div>
  </div>

  <!-- Inter-level overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="overlayTitle">Level Complete! üíñ</h2>
      <p id="overlayText">Ready for the next level?</p>
      <div class="modalActions">
        <button class="btn next" id="nextLevelBtn">Next Level ‚ûú</button>
        <button class="btn secondary" id="stayBtn">Practice Again</button>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // Content
    // -------------------------
    const levelData = {
      1: {
        name: "Level 1",
        goal: "Type the lowercase letters a‚Äìm.",
        items: "abcdefghijklm".split(""),
        mode: "chars"
      },
      2: {
        name: "Level 2",
        goal: "Type the uppercase letters N‚ÄìZ.",
        items: "NOPQRSTUVWXYZ".split(""),
        mode: "chars"
      },
      3: {
        name: "Level 3",
        goal: "Type Valentine words.",
        items: ["red","pink","flowers","card","candy","love","share","heart","note","nice","poem"],
        mode: "words"
      }
    };

    // Chromebook-like letter keyboard layout: letters only + Shift + Enter + Backspace
    // (lowercase labels on keys)
    const keyboardLayout = [
      ["q","w","e","r","t","y","u","i","o","p","backspace"],
      ["a","s","d","f","g","h","j","k","l","enter"],
      ["shift","z","x","c","v","b","n","m"]
    ];

    // -------------------------
    // State
    // -------------------------
    let level = 1;
    let index = 0;
    let hearts = 0;
    let wordTyped = "";
    let expectedKey = "";
    let finished = false;

    // Confetti
    const confettiCanvas = document.getElementById("confetti");
    const ctx = confettiCanvas.getContext("2d");
    let confettiPieces = [];
    let confettiTimer = 0;

    // -------------------------
    // Elements
    // -------------------------
    const promptEl = document.getElementById("prompt");
    const levelLabelEl = document.getElementById("levelLabel");
    const stepLabelEl = document.getElementById("stepLabel");
    const progressEl = document.getElementById("progressBar");
    const goalTextEl = document.getElementById("goalText");
    const heartsEl = document.getElementById("hearts");
    const assistEl = document.getElementById("assist");

    const wordAreaEl = document.getElementById("wordArea");
    const wordTargetEl = document.getElementById("wordTarget");
    const typedLineEl = document.getElementById("typedLine");

    const btn1 = document.getElementById("lvl1");
    const btn2 = document.getElementById("lvl2");
    const btn3 = document.getElementById("lvl3");
    const restartBtn = document.getElementById("restart");

    const kbEl = document.getElementById("kb");

    const overlayEl = document.getElementById("overlay");
    const overlayTitleEl = document.getElementById("overlayTitle");
    const overlayTextEl = document.getElementById("overlayText");
    const nextLevelBtn = document.getElementById("nextLevelBtn");
    const stayBtn = document.getElementById("stayBtn");

    // -------------------------
    // Keyboard rendering
    // -------------------------
    function keyLabel(k){
      if (k === "backspace") return "backspace";
      if (k === "shift") return "shift";
      if (k === "enter") return "enter";
      return k; // lowercase letters only
    }

    function keyClasses(k){
      const base = ["key"];
      if (k === "backspace") base.push("wide","smallText");
      if (k === "shift") base.push("wide","smallText");
      if (k === "enter") base.push("enter","smallText");
      return base.join(" ");
    }

    function buildKeyboard(){
      kbEl.innerHTML = "";
      keyboardLayout.forEach(row => {
        const rowEl = document.createElement("div");
        rowEl.className = "row";
        row.forEach(k => {
          const keyEl = document.createElement("div");
          keyEl.className = keyClasses(k);
          keyEl.dataset.key = k;
          keyEl.textContent = keyLabel(k);
          rowEl.appendChild(keyEl);
        });
        kbEl.appendChild(rowEl);
      });
    }

    function clearKeyClasses(){
      document.querySelectorAll(".key").forEach(el => {
        el.classList.remove("need","down","pulse");
      });
    }

    function highlightExpected(){
      clearKeyClasses();
      if (!assistEl.checked || !expectedKey) return;

      // expectedKey is letter, "shift", "enter", "backspace"
      const lookup = expectedKey.toLowerCase();
      const el = document.querySelector(`.key[data-key="${lookup}"]`);
      if (el) el.classList.add("need");
    }

    function showKeyDown(datasetKey){
      const el = document.querySelector(`.key[data-key="${datasetKey}"]`);
      if (!el) return;
      el.classList.add("down");
      setTimeout(() => el.classList.remove("down"), 120);
    }

    function pulseExpected(){
      if (!assistEl.checked || !expectedKey) return;
      const el = document.querySelector(`.key[data-key="${expectedKey.toLowerCase()}"]`);
      if (!el) return;
      el.classList.add("pulse");
      setTimeout(() => el.classList.remove("pulse"), 220);
    }

    // -------------------------
    // Progress + Prompt
    // -------------------------
    function setActiveButton(){
      [btn1,btn2,btn3].forEach(b => b.classList.remove("active"));
      if (level === 1) btn1.classList.add("active");
      if (level === 2) btn2.classList.add("active");
      if (level === 3) btn3.classList.add("active");
    }

    function totalSteps(){ return levelData[level].items.length; }

    function updateProgress(){
      const total = totalSteps();
      const done = Math.min(index, total);
      progressEl.style.width = `${(done/total)*100}%`;
      stepLabelEl.textContent = `${Math.min(index+1,total)} / ${total}`;
      heartsEl.textContent = `${hearts}`;
    }

    function setPromptForChars(){
      const items = levelData[level].items;
      const current = items[index];
      finished = false;

      wordAreaEl.style.display = "none";
      promptEl.style.fontSize = "clamp(30px, 6vw, 64px)";
      promptEl.textContent = current || "";

      // Keyboard helper:
      // - for uppercase, highlight shift as a helpful cue (letters remain lowercase on keys)
      if (current && /^[A-Z]$/.test(current)) expectedKey = "shift";
      else expectedKey = (current || "").toLowerCase();

      highlightExpected();
    }

    function setPromptForWords(){
      const words = levelData[level].items;
      const target = words[index];
      finished = false;

      promptEl.style.fontSize = "clamp(30px, 5vw, 54px)";
      promptEl.textContent = "üíñ";

      wordAreaEl.style.display = "block";
      wordTargetEl.textContent = target;
      renderTypedLine(target, wordTyped);

      expectedKey = (target && target[wordTyped.length]) ? target[wordTyped.length].toLowerCase() : "";
      highlightExpected();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderTypedLine(target, typed){
      let html = "";
      for (let i=0; i<Math.max(target.length, typed.length); i++){
        const t = target[i] ?? "";
        const u = typed[i] ?? "";
        if (!u) html += `<span>${escapeHtml(t)}</span>`;
        else if (u === t) html += `<span class="ok">${escapeHtml(u)}</span>`;
        else html += `<span class="bad">${escapeHtml(u)}</span>`;
      }
      typedLineEl.innerHTML = html || "<span class='small'>Start typing‚Ä¶</span>";
    }

    // -------------------------
    // Overlay (Next Level between levels)
    // -------------------------
    function showOverlay(){
      overlayTitleEl.textContent = `Level ${level} Complete! üíñ`;
      if (level < 3) overlayTextEl.textContent = "Great job! Ready for the next level?";
      else overlayTextEl.textContent = "You finished all the levels! Want to play again?";
      nextLevelBtn.style.display = (level < 3) ? "inline-flex" : "none";
      overlayEl.classList.add("show");
    }

    function hideOverlay(){
      overlayEl.classList.remove("show");
    }

    // -------------------------
    // Confetti (hearts + flowers)
    // -------------------------
    function resizeConfetti(){
      // canvas fits promptBox area (already positioned)
      const box = confettiCanvas.parentElement.getBoundingClientRect();
      confettiCanvas.width = Math.floor(box.width * devicePixelRatio);
      confettiCanvas.height = Math.floor(box.height * devicePixelRatio);
      confettiCanvas.style.width = box.width + "px";
      confettiCanvas.style.height = box.height + "px";
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }

    function spawnConfettiBurst(){
      resizeConfetti();
      const box = confettiCanvas.getBoundingClientRect();
      const centerX = box.width / 2;
      const centerY = box.height / 2;

      const shapes = ["heart","flower"];
      const colors = ["#e11d48","#c81e1e","#ff4d8d","#ffb3c7","#ffffff"];

      for (let i=0; i<90; i++){
        const angle = (Math.random() * Math.PI * 2);
        const speed = 2.2 + Math.random() * 3.2;

        confettiPieces.push({
          x: centerX + (Math.random()*30 - 15),
          y: centerY + (Math.random()*10 - 5),
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed - (1.5 + Math.random()*1.2),
          r: 6 + Math.random()*8,
          rot: Math.random() * Math.PI * 2,
          vr: (Math.random() - .5) * 0.25,
          g: 0.09 + Math.random()*0.05,
          life: 90 + Math.random()*40,
          shape: shapes[Math.floor(Math.random()*shapes.length)],
          color: colors[Math.floor(Math.random()*colors.length)]
        });
      }
      confettiTimer = 140; // frames to keep drawing
      requestAnimationFrame(drawConfetti);
    }

    function drawHeart(x,y,r,rot,color){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.fillStyle = color;
      ctx.beginPath();
      // simple heart using bezier curves
      const s = r/10;
      ctx.moveTo(0, 3*s);
      ctx.bezierCurveTo(0, -2*s, -5*s, -2*s, -5*s, 2*s);
      ctx.bezierCurveTo(-5*s, 6*s, 0, 8*s, 0, 10*s);
      ctx.bezierCurveTo(0, 8*s, 5*s, 6*s, 5*s, 2*s);
      ctx.bezierCurveTo(5*s, -2*s, 0, -2*s, 0, 3*s);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function drawFlower(x,y,r,rot,color){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.fillStyle = color;

      const petals = 6;
      for (let i=0;i<petals;i++){
        ctx.rotate((Math.PI*2)/petals);
        ctx.beginPath();
        ctx.ellipse(0, -r*0.6, r*0.35, r*0.55, 0, 0, Math.PI*2);
        ctx.fill();
      }
      // center
      ctx.fillStyle = "#ffd1dc";
      ctx.beginPath();
      ctx.arc(0,0, r*0.25, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function drawConfetti(){
      if (confettiTimer <= 0){
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        confettiPieces = [];
        return;
      }

      const box = confettiCanvas.getBoundingClientRect();
      ctx.clearRect(0,0,box.width,box.height);

      confettiPieces = confettiPieces.filter(p => p.life > 0);
      for (const p of confettiPieces){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.g;
        p.rot += p.vr;
        p.life -= 1;

        if (p.shape === "heart") drawHeart(p.x,p.y,p.r,p.rot,p.color);
        else drawFlower(p.x,p.y,p.r,p.rot,p.color);
      }

      confettiTimer -= 1;
      requestAnimationFrame(drawConfetti);
    }

    window.addEventListener("resize", () => {
      // keep confetti canvas aligned
      resizeConfetti();
    });

    // -------------------------
    // Level loading / finishing
    // -------------------------
    function loadLevel(newLevel){
      level = newLevel;
      index = 0;
      wordTyped = "";
      finished = false;

      setActiveButton();
      levelLabelEl.textContent = levelData[level].name;
      goalTextEl.textContent = levelData[level].goal;

      if (levelData[level].mode === "chars") setPromptForChars();
      else setPromptForWords();

      updateProgress();
      hideOverlay();
    }

    function restart(){
      index = 0;
      wordTyped = "";
      hearts = 0;
      finished = false;

      if (levelData[level].mode === "chars") setPromptForChars();
      else setPromptForWords();

      updateProgress();
      hideOverlay();
    }

    function finishLevel(){
      finished = true;
      progressEl.style.width = "100%";
      stepLabelEl.textContent = `${totalSteps()} / ${totalSteps()}`;

      // Celebrate!
      promptEl.textContent = "üíóüå∏";
      expectedKey = "";
      highlightExpected();

      spawnConfettiBurst();
      setTimeout(showOverlay, 450);
    }

    // -------------------------
    // Input handling
    // -------------------------
    function showKeyDownFromEvent(e){
      if (e.key === "Backspace") showKeyDown("backspace");
      else if (e.key === "Enter") showKeyDown("enter");
      else if (e.key === "Shift") showKeyDown("shift");
      else if (/^[a-z]$/i.test(e.key)) showKeyDown(e.key.toLowerCase());
    }

    function handleCharModeKey(e){
      const items = levelData[level].items;
      const want = items[index];
      if (!want) return;

      showKeyDownFromEvent(e);

      // We require exact match for the character (upper or lower).
      if (e.key === want){
        hearts++;
        index++;
        updateProgress();

        if (index >= items.length){
          finishLevel();
          return;
        }
        setPromptForChars();
      } else {
        pulseExpected();
      }
    }

    function handleWordModeKey(e){
      const words = levelData[level].items;
      const target = words[index];
      if (!target) return;

      showKeyDownFromEvent(e);

      if (e.key === "Backspace"){
        wordTyped = wordTyped.slice(0,-1);
        renderTypedLine(target, wordTyped);
        expectedKey = target[wordTyped.length] ? target[wordTyped.length].toLowerCase() : "";
        highlightExpected();
        return;
      }

      // Only letters for these words
      if (!/^[a-z]$/i.test(e.key)) return;

      const ch = e.key.toLowerCase();
      const nextWanted = target[wordTyped.length];

      wordTyped += ch;
      if (ch === nextWanted){
        hearts++;
      } else {
        pulseExpected();
      }

      renderTypedLine(target, wordTyped);

      // Completion check
      if (wordTyped.length >= target.length){
        if (wordTyped === target){
          index++;
          wordTyped = "";
          updateProgress();

          if (index >= words.length){
            finishLevel();
            return;
          }
          setPromptForWords();
        } else {
          // reset on incorrect full word to keep it simple for K‚Äì2
          wordTyped = "";
          renderTypedLine(target, wordTyped);
          expectedKey = target[0] ? target[0].toLowerCase() : "";
          highlightExpected();
        }
      } else {
        expectedKey = target[wordTyped.length] ? target[wordTyped.length].toLowerCase() : "";
        highlightExpected();
      }
    }

    window.addEventListener("keydown", (e) => {
      // prevent page actions
      if ([" ", "ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
      if (e.key === "Alt" || e.key === "Meta" || e.key === "Control") return;
      if (finished) return;
      if (index >= totalSteps()) return;

      if (levelData[level].mode === "chars") handleCharModeKey(e);
      else handleWordModeKey(e);
    }, {passive:false});

    // Buttons
    btn1.addEventListener("click", () => loadLevel(1));
    btn2.addEventListener("click", () => loadLevel(2));
    btn3.addEventListener("click", () => loadLevel(3));
    restartBtn.addEventListener("click", restart);
    assistEl.addEventListener("change", highlightExpected);

    nextLevelBtn.addEventListener("click", () => {
      hideOverlay();
      loadLevel(Math.min(3, level + 1));
    });

    stayBtn.addEventListener("click", () => {
      hideOverlay();
      // practice same level again
      index = 0;
      wordTyped = "";
      finished = false;
      if (levelData[level].mode === "chars") setPromptForChars();
      else setPromptForWords();
      updateProgress();
    });

    // Init
    buildKeyboard();
    loadLevel(1);
    // pre-size confetti canvas
    setTimeout(resizeConfetti, 50);
  </script>
</body>
</html>
